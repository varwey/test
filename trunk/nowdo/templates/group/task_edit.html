{% extends "layout/layout.html" %}

{% block extra_js %}
    <script type="text/javascript">
        seajs.use(['nowdo', '$'], function(nowdo, $){
            $(function(){
                new nowdo.publisher.PublisherView().options({
                    redirect: '{{ url_for('personal.published_tasks', user_id=current_user.id) }}'
                }).toggleTextEditor();
                function sendFile(file, editor, welEditable) {
                    var data = new FormData();
                    data.append("file", file);
                    $.ajax({
                        data: data,
                        type: "POST",
                        url: "/file/save",
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function(res) {
                            if(res.status == 'ok'){
                                editor.insertImage(welEditable, res.url);
                            }else{
                                nowdo.alertView.alert(res);
                            }
                        }
                    });
                }

                $('#task_content').summernote({
                    height: "300px",
                    toolbar: [
                        ['insert', ['picture', 'link']]
                    ],
                    onImageUpload: function(files, editor, welEditable) {
                        var target_file = files[0];
                        if(!target_file){
                            return;
                        }
                        if(!(/\.(gif|jpg|jpeg|png)$/i).test(target_file.name)){
                            nowdo.alertView.alert({info: '不支持的图片格式', category: 'danger'});
                            return;
                        }
                        if(target_file.size > 3 * 1024 * 1024){
                            nowdo.alertView.alert({info: '文件最大不能超过3M', category: 'danger'});
                            return;
                        }
                        sendFile(files[0], editor, welEditable);
                    }
                });
            });
        });
    </script>
{% endblock %}

{% block content %}
    {{ macros.render_publisher(create_task_form, url_for('task.edit_task', task_id=task.id), task_type=['text']) }}
{% endblock %}

{% block sidebar %}
    {{ macros.render_user_profile_card(task.get_creator()) }}
    <a href="{{ url_for('personal.published_tasks', user_id=current_user.id) }}" class="btn btn-primary form-control bottom-gap">
        <i class="fa fa-reply"></i>
        返回
    </a>
{% endblock %}