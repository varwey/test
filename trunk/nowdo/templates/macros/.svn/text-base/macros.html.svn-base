{% macro render_panel_xc(title, index_page_panel=False, extra_css='', extra_link=None, extra_link_title='') %}
    <div class="panel panel-default panel-xc {{ extra_css }}">
        {% if index_page_panel %}
            <div class="panel-heading main">
                {{ title }}
                <span class="pull-right">
                    <a class="more-link" href="#"></a>
                </span>
            </div>
        {% else %}
            <div class="panel-heading">
                {{ title }}
                {% if extra_link %}
                    <a class="pull-right" href="{{ extra_link }}" title="{{ extra_link_title }}">
                        <i class="fa fa-plus"></i>
                    </a>
                {% endif %}
            </div>
        {% endif %}
        {{ caller() }}
    </div>
{% endmacro %}

{% macro render_panel_content(h1_title=None, h2_title=None, use_list=False, extra_class=None) %}
    <div class="panel panel-default panel-content {% if extra_class %}{{ extra_class }}{% endif %}">
        {% if h1_title %}
            <div class="panel-heading">
                <h1>{{ h1_title }}</h1>
            </div>
        {% elif h2_title %}
            <div class="panel-heading">
                <h2>{{ h2_title }}</h2>
            </div>
        {% endif %}
        {% if use_list %}
            {{ caller() }}
        {% else %}
            <div class="panel-body">
                {{ caller() }}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{# 空列表提示信息 #}
{% macro empty_list_info(info) %}
    <div class="panel panel-topic">
        <div class="panel-heading">
            {{ info }}
        </div>
    </div>
{% endmacro %}

{# 小组管理页面导航选项卡 #}
{% macro setting_nav(flag, group_id) %}
    <ul class="nav nav-pills bottom-gap">
        <li class="{{ 'active' if flag == 'common_setting' else '' }}">
            <a href="{{ url_for('group.common_setting', group_id=group_id) }}">基本信息</a>
        </li>
        <li class="{{ 'active' if flag == 'members' else '' }}">
            <a href="{{ url_for('group.members', group_id=group_id) }}">成员管理</a>
        </li>
{#        <li class="{{ 'active' if flag == 'task_manage' else '' }}">#}
{#            <a href="{{ url_for('group.task_manage', group_id=group_id) }}">任务管理</a>#}
{#        </li>#}
        <li class="{{ 'active' if flag == 'avatar_manage' else '' }}">
            <a href="{{ url_for('group.avatar_manage', group_id=group_id) }}">头像管理</a>
        </li>
    </ul>
{% endmacro %}

{# 浏览发现导航选项卡 #}
{% macro explore_nav() %}
    <div class="btn-group btn-group-justified bottom-gap explore_nav">
            <a href="{{ url_for('frontend.explore') }}"
               class="btn btn-default {{ 'active' if request.endpoint == 'frontend.explore' else '' }}">浏览</a>

            <a href="{{ url_for('frontend.explore_tags') }}"
               class="btn btn-default {{ 'active' if request.endpoint == 'frontend.explore_tags' else '' }}">标签</a>

            <a href="{{ url_for('frontend.explore_tasks') }}"
               class="btn btn-default {{ 'active' if request.endpoint == 'frontend.explore_tasks' else '' }}">主题</a>

            <a href="{{ url_for('frontend.explore_groups') }}"
               class="btn btn-default {{ 'active' if request.endpoint == 'frontend.explore_groups' else '' }}">小组</a>
    </div>
{#    <ul class="nav nav-pills explore_nav bottom-gap">#}
{#        <li class="{{ 'active' if request.endpoint == 'frontend.explore' else '' }}">#}
{#            <a href="{{ url_for('frontend.explore') }}">浏览</a>#}
{#        </li>#}
{#        <li class="{{ 'active' if request.endpoint == 'frontend.explore_tags' else '' }}">#}
{#            <a href="{{ url_for('frontend.explore_tags') }}">标签</a>#}
{#        </li>#}
{#        <li class="{{ 'active' if request.endpoint == 'frontend.explore_tasks' else '' }}">#}
{#            <a href="{{ url_for('frontend.explore_tasks') }}">主题</a>#}
{#        </li>#}
{#        <li class="{{ 'active' if request.endpoint == 'frontend.explore_groups' else '' }}">#}
{#            <a href="{{ url_for('frontend.explore_groups') }}">小组</a>#}
{#        </li>#}
{#    </ul>#}
{% endmacro %}

{# 我的账号页面导航选项卡 #}
{% macro account_nav(endpoint) %}
    <ul class="nav nav-pills bottom-gap">
        <li class="{{ 'active' if endpoint == 'personal.my_profile' else '' }}">
            <a href="{{ url_for('personal.my_profile') }}">基本信息</a>
        </li>
        <li class="{{ 'active' if endpoint == 'personal.my_avatar' else '' }}">
            <a href="{{ url_for('personal.my_avatar') }}">我的头像</a>
        </li>
    </ul>
{% endmacro %}

{# 术语页面二级导航选项卡 #}
{% macro glossary_nav(flag, no_gap=False) %}
    <ul class="nav nav-pills {% if not no_gap %}bottom-gap{% endif %}">
        <li class="{{ 'active' if flag == 'glossary_table' else '' }}">
            <a href="{{ url_for('glossary.index') }}">我的术语表</a>
        </li>
        <li class="{{ 'active' if flag == 'checking-glossary' else '' }}">
            <a href="{{ url_for('glossary.checking') }}">待审核的术语</a>
        </li>
    </ul>
{% endmacro %}

{# 小组管理页面导航选项卡 #}
{% macro management_nav(endpoint) %}
    <ul class="nav nav-pills">
        <li class="{{ 'active' if endpoint == 'management.tags' else '' }}">
            <a href="{{ url_for('management.tags') }}">所有标签</a>
        </li>
        <li class="{{ 'active' if endpoint == 'management.featured_tags' else '' }}">
            <a href="{{ url_for('management.featured_tags') }}">精选标签</a>
        </li>
    </ul>
{% endmacro %}

{# 主题页面二级导航选项卡 #}
{% macro task_nav(user, no_gap=True) %}
    <ul class="nav nav-pills {% if not no_gap %}bottom-gap{% endif %}">
        <li class="{{ 'active' if request.endpoint == 'personal.published_tasks' else '' }}">
            <a href="{{ url_for('personal.published_tasks', user_id=user.id) }}">发布的主题</a>
        </li>
        <li class="{{ 'active' if request.endpoint == 'personal.participated_tasks' else '' }}">
            <a href="{{ url_for('personal.participated_tasks', user_id=user.id) }}">参与的主题</a>
        </li>
        <li class="{{ 'active' if request.endpoint == 'personal.liked_tasks' else '' }}">
            <a href="{{ url_for('personal.liked_tasks', user_id=user.id) }}">喜欢的主题</a>
        </li>
    </ul>
{% endmacro %}

{# 我的脑洞页面导航选项卡 #}
{% macro my_home_nav(user) %}
    <ul class="nav nav-pills bottom-gap">
{#        <li class="{{ 'active' if flag == 'index' else '' }}">#}
{#            <a href="{{ url_for('personal.index', user_id=user.id) }}">主页</a>#}
{#        </li>#}
        <li class="{{ 'active' if request.endpoint in ['personal.liked_tasks', 'personal.participated_tasks', 'personal.published_tasks' ] else '' }}">
            <a href="{{ url_for('personal.published_tasks', user_id=user.id) }}">主题</a>
        </li>
        <li class="{{ 'active' if request.endpoint == 'personal.joined_groups' else '' }}">
            <a href="{{ url_for('personal.joined_groups', user_id=user.id) }}">加入的小组</a>
        </li>
        <li class="{{ 'active' if request.endpoint == 'personal.followed_users' else '' }}">
            <a href="{{ url_for('personal.followed_users', user_id=user.id) }}">关注的人</a>
        </li>

        {% if user.id == current_user.id %}
            <li class="{{ 'active' if request.endpoint == 'personal.reg_invitation' else '' }}">
                <a href="{{ url_for('personal.reg_invitation', user_id=user.id) }}">邀请</a>
            </li>

{#        术语放在这里真不妥，不过，老大说了，临时先放在这 #}
            <li class="{{ 'active' if request.endpoint in ['glossary.index', 'glossary.glossary_list'] else '' }}">
                <a href="{{ url_for('glossary.index') }}">术语</a>
            </li>
        {% endif %}
{#        <li class="{{ 'active' if flag == 'published_topics' else '' }}">#}
{#            <a href="{{ url_for('personal.published_topics', user_id=user.id) }}">发布的话题</a>#}
{#        </li>#}
{#        <li class="{{ 'active' if flag == 'commented_topics' else '' }}">#}
{#            <a href="{{ url_for('personal.commented_topics', user_id=user.id) }}">回复的话题</a>#}
{#        </li>#}
    </ul>
{% endmacro %}

{# 列表标题 #}
{% macro render_list_title(title, more_url=None, create_url=None, create_label=None) %}
    <div class="panel title-panel">
        <div class="panel-heading">
            <strong>
                {{ title }}
            </strong>
            {% if more_url %}
                <span class="pull-right">
                    <a class="" href="{{ more_url }}">更多</a>
                </span>
            {% endif %}
            {% if create_url and create_label %}
                <span class="pull-right">
                    <a class="" href="{{ create_url }}">{{ create_label }}</a>
                </span>
            {% endif %}
        </div>
    </div>
{% endmacro %}


{# 分页导航 #}
{% macro render_pagination(pagination, endpoint, kwargs=None, user=None) %}
    {% if pagination and pagination.paginator.num_pages > 1 %}
        <ul class=pagination>
            {% for page in pagination.iter_pages() %}
                {% if page %}
                    {% if page != pagination.number %}
                        <li>
                            {% if user %}
                                <a href="{{ url_for(endpoint, page=page, user_id=user.id) }}">{{ page }}</a>
                            {% elif kwargs %}
                                <a href="{{ url_for(endpoint, page=page, **kwargs) }}">{{ page }}</a>
                            {% else %}
                                <a href="{{ url_for(endpoint, page=page) }}">{{ page }}</a>
                            {% endif %}
                        </li>
                    {% else %}
                        <li class="active">
                            <a href="javascript:void(0);">{{ page }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <span class=ellipsis>…</span>
                {% endif %}
                <li>
                </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endmacro %}

{% macro render_task_list(object_list, show_avatar=True, show_time=True, truncate=None) %}
    <div class="panel-body">
        <ul class="task-list">
            {% for task in object_list %}
                <li class="">
                    {% if show_avatar %}
                        <img src="{{ task.get_creator().avatar_url(20) }}" alt=""/>
                    {% endif %}
                    <a href="{{ task.task_link }}" target="_blank">
                        {% if truncate %}
                            <div class="overflow-text">{{ task.name }}</div>
                        {% else %}
                            {{ task.name }}
                        {% endif %}
                    </a>
{#                    {% if not task.is_translating %}#}
{#                        <span title="任务未开启">#}
{#                                <i class="fa fa-lock"></i>#}
{#                            </span>#}
{#                    {% endif %}#}
                    {% if show_time %}
                        <span class="time-label">
                            {{ task.created_date|delta }}
                        </span>
                    {% endif %}
                </li>
            {% else %}
                <li class="">
                    什么主题都木有...
                </li>
            {% endfor %}
        </ul>
    </div>
{% endmacro %}

{# 任务列表 #}
{% macro render_task_list_panel(object_list, supported_languages, create_task_url, list_title=None) %}
    <div class="panel panel-default panel-content">
        {% if list_title %}
        <div class="panel-heading">
            <h2>
                {{ list_title }}
                {% if create_task_url %}
                    <a href="{{ create_task_url }}" class="pull-right create-url">发布新主题</a>
                {% endif %}
            </h2>
        </div>
        {% endif %}
        {{ render_task_list(object_list) }}
    </div>
{% endmacro %}

{# 主题时间归档列表 #}
{% macro render_time_archive_task_list(task_list) %}
    <div class="archive-task-card-list">
        {% for month, archive_list in task_list|groupby('time_archive')|reverse %}
            <h3>{{ month }} / {{ archive_list|length }} 个主题</h3>
            {% for task in archive_list %}
                <div class="archived-task-card">
{#                    {% if task.summery_image_url %}#}
{#                        <img src="{{ task.summery_image_url }}" alt=""/>#}
{#                    {% else %}#}
                        <strong>
                            {{ task.name|truncate(10, true) }}
                        </strong>
                        <div class="task-summary">
                            {{ task.task_content|striptags|truncate(40, true) }}
                        </div>
{#                    {% endif %}#}
                    <div class="hovered-ops link-to-target-url" data-target-url="{{ url_for('task.task_view', task_id=task.id) }}">
                        <div class="archive-time">
{#                            {{ task.created_date.strftime('%Y年%m月%d日') }}#}
                            {{ task.name|truncate(10, True) }}
                        </div>
                            <div class="languages">
                            {% if task.is_translating %}
                                {% for language, translated_entry_count, translated_word_count, translated_word_percent in task.tar_lang_list_with_translate_progress() %}
                                    <a href="javascript:void(0);"
                                       class="link-to-target-url"
                                       title="[{{ language|upper }}] {{ supported_languages[language] }} {{ translated_word_percent }}%"
                                       data-toggle="tooltip" data-placement="top" data-container="body"
                                       data-target-url="{{ task.read_link(language) }}">
                                        <span class="flag {{ language }}"></span>
                                    </a>
                                {% endfor %}
                            {% else %}
                                <a class="link-to-target-url"></a>
                            {% endif %}
                            </div>
                        {% if current_user.is_authenticated() and current_user.id == task.creator_id and request.endpoint == 'personal.published_tasks' %}
                            <a class="btn btn-success btn-sm link-to-target-url" data-target-url="{{ url_for('task.manage', task_id=task.id) }}" href="javascript:void(0);">
                                <i class="fa fa-cog"></i>
                                <span class="btn-text">
                                    管理主题
                                </span>
                            </a>
                        {% endif %}
{#                        <a class="btn btn-primary btn-sm" href="{{ url_for('task.task_view', task_id=task.id) }}">#}
{#                            <i class="fa fa-external-link"></i>#}
{#                            <span class="btn-text">#}
{#                                查看主题#}
{#                            </span>#}
{#                        </a>#}
                    </div>
                </div>
            {% endfor %}
{#            {{ render_trends_style_task(task) }}#}
        {% else %}
            木有主题
        {% endfor %}
    </div>
{% endmacro %}

{% macro render_trends_style_task(task) %}
    {% set creator = task.get_creator() %}
    <div class="trend clearfix">
        <div class="left-bar">
            <a href="{{ url_for('personal.index', user_id=creator.id) }}">
                <img class="media-object" src="{{ creator.avatar_url() }}" alt="{{ creator.nickname }}">
            </a>
        </div>
        <div class="trend-content">
            <div class="triangle"></div>
            <div class="trend-heading">
                {% if current_user.is_authenticated() and current_user.id == creator.id %}
                    {% if task.is_finished %}
                        <a class="btn btn-danger btn-sm pull-right disabled" href="" style="margin-top: -5px">
                            <i class="fa fa-check-circle"></i>
                            <span class="btn-text">
                                翻译已完成
                            </span>
                        </a>
                    {% elif not task.is_translating %}
                    <a class="btn btn-success btn-sm pull-right active-task {% if task.editable %}confirm-required{% endif %}"
                       data-task_id="{{ task.id|string }}" href="javascript:void(0);">
                        <i class="fa fa-check-circle"></i>
                        <span class="btn-text">
                            开启翻译
                        </span>
                    </a>
                    {% else %}
                        <a class="btn btn-info btn-sm pull-right active-task" data-task_id="{{ task.id|string }}" href="javascript:void(0);">
                            <i class="fa fa-minus-circle"></i>
                            <span class="btn-text">
                                关闭翻译
                            </span>
                        </a>
                    {% endif %}
                {% endif %}
                <h3>
                    <a class="" href="{{ task.task_link }}" target="_blank">
                        {{ task.name|truncate(30, True) }}
                    </a>
                </h3>
            </div>
            <div class="trend-body">
                {{ task.task_content|striptags|truncate(200, true) }}
{#                <div class="tags trend-meta">#}
{#                    {% for tag in task.tags %}#}
{#                        <a href="{{ url_for('frontend.tag_view', tag=tag.tag_name) }}" class="tag">#}
{#                            <i class="fa fa-tag"></i>#}
{#                            {{ tag.tag_name }}#}
{#                        </a>#}
{#                    {% endfor %}#}
{#                </div>#}
            </div>
            <div class="trend-footer">
            <span class="trend-meta pull-right">
                {{ task.created_date|delta }}
            </span>
                {% if current_user.is_authenticated() and current_user.id == creator.id %}
                    <span class="pull-right ops">
                        {% if task.editable %}
                            <a href="{{ url_for('task.edit_task', task_id=task.id) }}">
                                <i class="fa fa-edit"></i>
                                编辑
                            </a>
                        {% endif %}
{#                        <a href="">#}
{#                            <i class="fa fa-trash-o"></i>#}
{#                            删除#}
{#                        </a>#}
                    </span>
                {% endif %}
            <div class="trend-meta clearfix">
                {% for tag in task.tags %}
                    <a href="{{ url_for('frontend.tag_view', tag=tag.tag_name) }}" class="tag">
                        <i class="fa fa-tag"></i>
                        {{ tag.tag_name }}
                    </a>
                {% endfor %}
            </div>
            </div>
        </div>
    </div>
{% endmacro %}

{% macro render_trends_style_task_list(task_list) %}
    <div class="trends">
        {% for task in task_list %}
            {{ render_trends_style_task(task) }}
        {% else %}
            {% call render_panel_content() %}
                没有任何相关的主题
            {% endcall %}
        {% endfor %}
    </div>
{% endmacro %}

{% macro render_task_tag_rel(task_tag_rel, supported_languages, with_mark_btn=True) %}
    {% set task = task_tag_rel.task %}
    {% set creator = task.get_creator() %}
    <div class="trend clearfix">
        <div class="left-bar">
            <a href="{{ url_for('personal.index', user_id=creator.id) }}">
                <img class="media-object" src="{{ creator.avatar_url() }}" alt="{{ creator.nickname }}">
            </a>
        </div>
        <div class="trend-content">
            <div class="triangle"></div>
            <div class="trend-heading">
                {% if with_mark_btn %}
                    {% if task_tag_rel.is_featured %}
                        <a class="btn btn-info btn-sm pull-right featured" data-task_id="{{ task.id|string }}" href="javascript:void(0);">
                            <i class="fa fa-minus"></i>
                            <span class="btn-text">
                                取消精选
                            </span>
                        </a>
                    {% else %}
                        <a class="btn btn-success btn-sm pull-right featured" data-task_id="{{ task.id|string }}" href="javascript:void(0);">
                            <i class="fa fa-plus"></i>
                            <span class="btn-text">
                                加入精选
                            </span>
                        </a>
                    {% endif %}
                {% endif %}
                <h3>
                    <a class="" href="{{ url_for('task.task_view', task_id=task.id) }}">{{ task.name|truncate(30 if with_mark_btn else 35, True) }}</a>
                </h3>
            </div>
            <div class="trend-body" data-status="close">
                <div class="part-text">
                {% if task.summery_image_url %}
                    <div class="summary-image">
                        <a class="" href="{{ task.summery_image_url }}"
                           target="_blank">
                            <img src="{{ task.summery_image_url }}" alt=""/>
                        </a>
                    </div>
                {% endif %}
                    {{ task.task_content|strip_img_tags|escape_unsafe_tags|html_truncate(300)|safe }}
                </div>
                {% if task.show_expand or task.summery_image_url %}
                <div class="full-text hide">
                    {% if task.type == 0 %}
                    {{ task.task_content|escape_unsafe_tags|safe }}
                    {% elif task.type == 1 %}
                    {% for image in task.images %}
                        <div class="img-task-item">
                        <a class="" href="{{ image.image_url }}" target="_blank">
                            <img src="{{ image.image_url }}">
                        </a>
                        </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
                <div class="clearfix"></div>
                {% if task.show_expand %}
                <a class="expand-trend" data-status="close" href="javascript:void(0);">
                    展开 <i class="fa fa-angle-down"></i>
                </a>
                {% endif %}
            </div>
            <div class="trend-footer">
            <span class="trend-meta pull-right">
                {{ task.created_date|delta }}
            </span>
{#            <div class="trend-meta clearfix">#}
{#                {% for lang in task.tar_lang_list() %}#}
{#                    <a class="" href="{{ task.read_link(lang) }}">#}
{#                        <i class="fa fa-globe"></i>#}
{#                        [{{ lang|upper }}] {{ supported_languages[lang] }}#}
{#                    </a>#}
{#                {% endfor %}#}
{#            </div>#}
                <div class="trend-meta clearfix">
                    {% for tag in task.tags %}
                        <a href="{{ url_for('frontend.tag_view', tag=tag.tag_name) }}" class="tag">
                            <i class="fa fa-tag"></i>
                            {{ tag.tag_name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endmacro %}

{% macro render_task_tag_rel_list(task_tag_rel_list, supported_languages, with_mark_btn=True) %}
    <div class="trends">
        {% for task_tag_rel in task_tag_rel_list %}
            {{ render_task_tag_rel(task_tag_rel, supported_languages, with_mark_btn=with_mark_btn) }}
        {% else %}
            {% call render_panel_content() %}
                没有主题
            {% endcall %}
        {% endfor %}
    </div>
{% endmacro %}

{# 带摘要的话题列表项 #}
{% macro render_topic_with_summary(topic) %}
    <div class="panel panel-topic">
        <div class="panel-heading">
            <a href="{{ url_for('group.topic_view', topic_id=topic.id) }}">{{ topic.title }}</a>
        </div>
        <div class="panel-body">
            {{ topic.content|truncate(100, True) }}
        </div>
        <div class="panel-footer">
            <span>
                <a class="meta-label" href="{{ url_for('group.topic_view', topic_id=topic.id) }}#comments">
                    <i class="fa fa-comment"></i>
                    {{ topic.comments|length }} 回复
                </a>
            </span>
            <span class="pull-right time-label">
               <a href="{{ url_for('personal.index', user_id=topic.creator.id) }}">
                   {{ topic.creator.nickname }}
               </a>
                创建于：{{ topic.created_date }}
            </span>
        </div>
    </div>
{% endmacro %}

{# 不带摘要的话题列表项 #}
{% macro render_topic(topic) %}
    <tr>
        <td>
            <a href="{{ url_for('group.topic_view', topic_id=topic.id) }}">
                {{ topic.title|truncate(45, True) }}
            </a>
        </td>
        <td class="meta">
            {{ topic.comments|length }} 回复
        </td>
        <td class="meta">
            <a href="{{ url_for('personal.index', user_id=topic.creator.id) }}">
                {{ topic.creator.nickname }}
            </a>
        </td>
        <td class="meta">
            {{ topic.created_date|delta }}
        </td>
    </tr>
{% endmacro %}


{# 话题列表 #}
{% macro render_topic_list(object_list) %}
    <table class="table table-topic">
        {% for topic in object_list %}
            {{ render_topic(topic) }}
        {% else %}
            <tr>
                <td>
                    没有话题
                </td>
            </tr>
        {% endfor %}
    </table>
{% endmacro %}


{# 带摘要的话题列表 #}
{% macro render_topic_list_with_summary(object_list) %}
    {% for topic in object_list %}
        {{ render_topic_with_summary(topic) }}
    {% else %}
        {{ empty_list_info('没有话题') }}
    {% endfor %}
{% endmacro %}


{# 小组卡片 #}
{% macro render_group_card(group, joined_count=None, avatar_only=False, large_size=False, horizontal=False, with_join_btn=False) %}
    <div class="card {% if large_size %}card-lg{% endif %} {% if horizontal %}card-horizontal{% endif %}">
        <div class="avatar">
            <a href="{{ url_for('group.group_home', group_id=group.id) }}"
               title="{{ group.group_name }}">
                {% if large_size %}
                    <img src="{{ group.avatar_url(80) }}" alt=""/>
                {% else %}
                    <img src="{{ group.avatar_url(50) }}" alt=""/>
                {% endif %}
            </a>
        </div>
        {% if avatar_only %}
        {% if with_join_btn %}
        <div class="slide-info">
            {% if current_user and current_user.is_authenticated() and current_user.joined(group.id) %}

                <a href="javascript:void(0);"
                   data-group_id="{{ group.id }}"
                   data-icon-only="true"
                   data-icon-style="circle"
                   title="退出小组"
                   class="join-group" data-loading-text="...">
                    <i class="fa fa-minus-circle"></i>
                </a>
            {% else %}
                <a href="javascript:void(0);"
                   data-group_id="{{ group.id }}"
                   data-icon-only="true"
                   data-icon-style="circle"
                   title="加入小组"
                   class="join-group" data-loading-text="...">
                    <i class="fa fa-plus-circle"></i>
                </a>
            {% endif %}
        </div>
        {% endif %}
        {% else %}
            <div class="card-content">
                <div class="title">
                    <a href="{{ url_for('group.group_home', group_id=group.id) }}" title="{{ group.group_name }}">
                        {{ group.group_name|truncate(10, true) }}
                    </a>
                </div>
                {% if not with_join_btn %}
                    {# 小卡片显示加入按钮时不显示加入人数 #}
                    <div class="count">
                        {{ joined_count or group.members | length}} 人加入
                    </div>
                {% endif %}
                {% if large_size or (not large_size and with_join_btn) %}
                    {# 如果是大号的小组卡片，显示 “加入小组” 按钮 #}
                    <div class="">
                        {% if current_user and current_user.is_authenticated() and current_user.joined(group.id) %}
                            <div class="text-muted joined-label">
                                <i class="fa fa-check"></i>
                                已加入
                            </div>
                        {% else %}
                            {% if with_join_btn %}
                                <a href="javascript:void(0);" data-group_id="{{ group.id }}" class="join-group">
                                    <i class="fa fa-plus"></i>
                                    <span class="btn-text">
                                        加入小组
                                    </span>
                                </a>
                            {% else %}
                                <a href="javascript:void(0);" data-group_id="{{ group.id }}" class="join-group btn btn-success btn-sm">
                                    <i class="fa fa-plus"></i>
                                    <span class="btn-text">
                                        加入小组
                                    </span>
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{# 侧边栏小的小组卡片列表 #}
{% macro render_group_list(group_list, with_member_count=True, avatar_only=False, with_join_btn=False) %}
    <div class="card-list{{ ' avatar-only' if avatar_only else ''}}">
        {% for group_and_member_count in group_list %}
            {% set group, member_count = group_and_member_count if with_member_count else (group_and_member_count, None) %}
            {{ render_group_card(group, member_count, avatar_only=avatar_only, with_join_btn=with_join_btn) }}
        {% endfor %}
    </div>
{% endmacro %}

{# 横向大的小组卡片列表，用户浏览发现页面 #}
{% macro render_horizontal_group_card_list(group_list, current_user=None, empty_info=None, large_size=True, with_joined_count=True)  %}
    <div class="card-list">
        {% for row in group_list %}
            {% set group, joined_count = row if with_joined_count else (row, None) %}
            {{ render_group_card(group, joined_count, large_size=large_size) }}
        {% endfor %}
    </div>
{% endmacro %}

{# 横向大的小组卡片列表，用户首页 #}
{% macro render_big_horizontal_group_card_list(group_list) %}
    <ul class="recom-follow">
    {% for row in group_list %}
        {% set group, joined_count = row %}
        <li class="big">
            <a class="mi" href="{{ url_for('group.group_home', group_id=group.id) }}" title="{{ group.group_name }}">
                <span class="w-img2 w-img2-1">
                    <img src="{{ group.avatar_url(50) }}" alt=""/>
                </span>
                <span class="txt txt-in">
                    <span class="us">
                        <span class="f-pr f-ib etag">
                            <span class="limit f-ib itag">{{ group.group_name }}</span>
                        </span>
                    </span>
                    <span class="in">{{ joined_count or group.members | length}}人加入</span>
                </span>
            </a>
            {% if current_user and current_user.is_authenticated() and current_user.joined(group.id) %}
                <a href="javascript:void(0);"
                   data-group_id="{{ group.id }}"
                   data-icon-only="true"
                   data-icon-style="circle"
                   title="退出小组"
                   class="join-group w-icn2" data-loading-text="...">
                    <i class="fa fa-minus-square"></i>
                </a>
            {% else %}
                <a href="javascript:void(0);"
                   data-group_id="{{ group.id }}"
                   data-icon-only="true"
                   data-icon-style="circle"
                   title="加入小组"
                   class="join-group w-icn2" data-loading-text="...">
                    <i class="fa fa-plus-square"></i>
                </a>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% endmacro %}

{# 用户卡片 #}
{% macro render_user_card(user, trends_count=None, avatar_only=False, large_size=False, horizontal=False, with_follow_btn=False) %}
    <div class="card {% if large_size %}card-lg{% endif %} {% if horizontal %}card-horizontal{% endif %}">
        <div class="avatar">
            <a href="{{ url_for('personal.index', user_id=user.id) }}" title="{{ user.nickname }}">
                {% if large_size %}
                    <img src="{{ user.avatar_url(80) }}" alt="{{ user.nickname }}"/>
                {% else %}
                    <img src="{{ user.avatar_url() }}" alt="{{ user.nickname }}"/>
                {% endif %}
            </a>
        </div>
        {% if avatar_only %}
            {% if with_follow_btn %}
            <div class="slide-info">
                {% if current_user and current_user.is_authenticated() and current_user.followed(user.id) %}
                    <a href="javascript:void(0);"
                       data-user_id="{{ user.id }}"
                       data-icon-only="true"
                       data-icon-style="circle"
                       title="取消关注"
                       class="follow-user" data-loading-text="...">
                        <i class="fa fa-minus-circle"></i>
                    </a>
                {% else %}
                    <a href="javascript:void(0);"
                       data-user_id="{{ user.id }}"
                       data-icon-only="true"
                       data-icon-style="circle"
                       title="关注此人"
                       class="follow-user" data-loading-text="...">
                        <i class="fa fa-plus-circle"></i>
                    </a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div class="card-content">
                <div class="title">
                    <a href="{{ url_for('personal.index', user_id=user.id) }}" title="{{ user.nickname }}">
                        {{ user.nickname|truncate(7, true) }}
                    </a>
                </div>
                {% if trends_count and not with_follow_btn %}
                    <div class="count">
                        活跃度：{{ trends_count }}
                    </div>
                {% endif %}
                {% if large_size or (with_follow_btn and not large_size) %}
                    <div class="">
                        {% if current_user and current_user.is_authenticated() and current_user.followed(user.id) %}
                            {% if with_follow_btn %}
                                <a href="javascript:void(0);" data-user_id="{{ user.id }}" class="follow-user" data-loading-text="正在提交...">
                                    <i class="fa fa-minus"></i>
                                    取消关注
                                </a>
                            {% else %}
                                <a href="javascript:void(0);" data-user_id="{{ user.id }}" class="follow-user btn btn-sm btn-success" data-loading-text="正在提交...">
                                    <i class="fa fa-minus"></i>
                                    取消关注
                                </a>
                            {% endif %}
                        {% else %}
                            {% if with_follow_btn %}
                                <a href="javascript:void(0);" data-user_id="{{ user.id }}" class="follow-user" data-loading-text="正在提交...">
                                    <i class="fa fa-plus"></i>
                                    关注
                                </a>
                            {% else %}
                                <a href="javascript:void(0);" data-user_id="{{ user.id }}" class="follow-user btn btn-sm btn-success" data-loading-text="正在提交...">
                                    <i class="fa fa-plus"></i>
                                    关注
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{# 小的用户列表 #}
{% macro render_user_list(user_list, user_id_trends_count_map=None, avatar_only=False, large_size=False, horizontal=False, with_follow_btn=False) %}
    <div class="card-list{{ ' avatar-only' if avatar_only else ''}}">
        {% for user in user_list %}
            {% set trends_count = user_id_trends_count_map[user.id] if user_id_trends_count_map else None %}
            {{ render_user_card(user, trends_count=trends_count, avatar_only=avatar_only, large_size=large_size, horizontal=horizontal, with_follow_btn=with_follow_btn) }}
        {% endfor %}
    </div>
{% endmacro %}


{# 横向大的用户列表，用户首页 #}
{% macro render_big_horizontal_user_list(user_list) %}
    <ul class="recom-follow">
    {% for user in user_list %}
        <li class="big">
            <a class="mi" href="{{ url_for('personal.index', user_id=user.id) }}" title="{{ user.nickname }}">
                <span class="w-img2 w-img2-1">
                    <img src="{{ user.avatar_url() }}" alt=""/>
                </span>
                <span class="txt txt-in">
                    <span class="us">
                        <span class="f-pr f-ib etag">
                            <span class="limit f-ib itag">{{ user.nickname }}</span>
                        </span>
                    </span>
                    <span class="in">{{ user.followd_count }}人关注</span>
                </span>
            </a>
            {% if current_user and current_user.is_authenticated() and current_user.followed(user.id) %}
                <a href="javascript:void(0);"
                   data-user_id="{{ user.id }}"
                   data-icon-only="true"
                   data-icon-style="circle"
                   title="取消关注"
                   class="follow-user w-icn2" data-loading-text="...">
                    <i class="fa fa-minus-square"></i>
                </a>
            {% else %}
                <a href="javascript:void(0);"
                   data-user_id="{{ user.id }}"
                   data-icon-only="true"
                   data-icon-style="circle"
                   title="关注"
                   class="follow-user w-icn2" data-loading-text="...">
                    <i class="fa fa-plus-square"></i>
                </a>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% endmacro %}


{# 收件人列表 #}
{% macro render_receiver_list(user_list) %}
    <div class="card-list">
        {% for user in user_list %}
            <div class="card">
                <div class="avatar">
                    <a href="{{ url_for('mail.write', to=user.id) }}" title="{{ user.nickname }}">
                        <img class="media-object center-block" src="{{ user.avatar_url() }}" alt="...">
                    </a>
                </div>
                <div class="card-content">
                    <div class="title">
                        {{ user.nickname|truncate(7, true) }}
                    </div>
                </div>
            </div>
        {% else %}
            <p>
                你还没有关注过任何人
            </p>
            <p>
                <a class="btn btn-primary btn-sm" href="{{ url_for('frontend.explore') }}">
                    寻找感兴趣的人
                </a>
            </p>
        {% endfor %}
    </div>
{% endmacro %}


{# 标签 #}
{% macro render_tag(tag, with_icon=False, count=None, with_hot=False, active_if=None, class='tag', endpoint='frontend.explore') %}
    <a class="{{ class }} {% if active_if == tag.tag_name %}active{% endif %}" href="{{ url_for(endpoint, tag=tag.tag_name) }}">
        {% if with_icon %}<i class="fa fa-tag"></i>{% endif %}
        {{ tag.tag_name }}
        {% if with_hot %}（{{ tag.hot }}）{% endif %}
        {% if count %}({{ count }}){% endif %}
    </a>
{% endmacro %}

{% macro render_trends_list(trends_list, supported_languages, empty_label='没有任何内容', current_user=None) %}
    {% for trends in trends_list %}
        <div class="trend clearfix">
            <div class="left-bar">
                <a href="{{ url_for('personal.index', user_id=trends.target_user.id) }}" target="_blank">
                    <img class="media-object" src="{{ trends.target_user.avatar_url() }}" alt="{{ trends.target_user.nickname }}">
                </a>
            </div>
            <div class="trend-content">
                <div class="triangle"></div>
                <div class="trend-heading">
                    <span class="action-str meta">
                        <a data-user_id="{{ trends.user.id }}"
                           href="{{ url_for('personal.index', user_id=trends.user.id) }}"
                           class="{{ 'user-info-pop' if not (current_user.is_authenticated() and trends.user.id == current_user.id) else '' }}">
                            {{ trends.user.nickname }}
                        </a>
                        {{ trends.action_str }}
                    </span>
                    {% if trends.target_type == 'task' %}
                        <a class="to-translate-btn {{ 'is_translating' if trends.target.is_translating else '' }}" href="{{ trends.target.task_link }}" title="主题详情" target="_blank"></a>
                        <h3>
                            <a class="" href="{{ trends.target.task_link }}" title="{{ trends.target_title }}" target="_blank">
                                <div class="overflow-text">{{ trends.target_title }}</div>
                            </a>
                        </h3>
                    {% else %}
                        <h3>
                            <a class="" href="{{ trends.target_url }}">
                                <div class="overflow-text">{{ trends.target_title }}</div>
                            </a>
                        </h3>
                    {% endif %}
                </div>


                <div class="trend-body clearfix" data-status="close">
                    {% if trends.target_type == 'group' %}
                        {{ trends.target_content|strip_img_tags|escape_unsafe_tags|safe }}
                    {% elif trends.target_type == 'task' %}
                        <div class="part-text">
                        {% if trends.target.summery_image_url %}
                            <div class="summary-image">
                                <a class="" href="{{ trends.target.summery_image_url }}"
                                   target="_blank">
                                    <img src="{{ trends.target.summery_image_url }}" alt=""/>
                                    {% set image_num = trends.target.image_num %}
                                    {% if image_num > 1 %}
                                    <span class="total">
                                        <span class="totalbg"></span>
                                        <span class="totalnum">{{ image_num }}</span>
                                    </span>
                                    {% endif %}
                                </a>
                            </div>
                        {% endif %}
                        {{ trends.target_content|strip_img_tags|escape_unsafe_tags|html_truncate(300)|safe }}
                        </div>
                        {% if trends.expand or trends.target.summery_image_url %}
                        <div class="full-text hide">
                            {% if trends.target.type == 0 %}
                            {{ trends.target_content|escape_unsafe_tags|safe }}
                            {% elif trends.target.type == 1 %}
                            {% for image in trends.target.image_list %}
                                <div class="img-task-item">
                                <a class="" href="{{ image.image_url }}" target="_blank">
                                    <img src="{{ image.image_url }}">
                                </a>
                                </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="clearfix"></div>
                        {% if trends.expand %}
                        <a class="expand-trend" href="javascript:void(0);">
                            展开 <i class="fa fa-angle-down"></i>
                        </a>
                        {% endif %}
                    {% endif %}
                    {% if trends.target_type in ['task', 'group'] %}
                        <div class="tags trend-meta">
                            {% for tag in trends.target.tags %}
                                <a href="{{ url_for('frontend.tag_view', tag=tag.tag_name) }}" class="tag">
                                    <i class="fa fa-tag"></i>
                                    {{ tag.tag_name }}
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="trend-footer">
                    <div class="trend-footer-line">
                        <span class="meta">
                            {{ trends.action_date|delta }}
                        </span>
                        {% if trends.target_type == 'task' %}
                            {% set i_love = (current_user.is_authenticated() and trends.user.id == current_user.id and trends.action == 'like') %}
                            {% set editable = (current_user.is_authenticated() and trends.user.id == current_user.id and trends.target.editable) %}

                            <span class="pull-right ops">
                                {% if editable %}
                                    <a href="{{ url_for('task.edit_task', task_id=trends.target.id) }}">
                                        <i class="fa fa-edit"></i>
                                        编辑
                                    </a>
                                {% endif %}
                                    <a href="javascript:void(0);" data-target_id="{{ trends.target.id }}" class="comment-btn">
                                        <i class="fa fa-comment-o"></i> 评论 (<span class="comment-count">{{ trends.target.comment_count }}</span>)
                                    </a>
                                <a href="javascript:void(0);" data-target_id="{{ trends.target.id }}" class="like-btn {% if i_love %}active{% endif %}">
                                    <i class="fa fa-heart{% if not i_love %}-o{% endif %}"></i> 喜欢(<span class="like-count">{{ trends.target.like_count }}</span>)
                                </a>
                            </span>

                            {% if trends.target.is_translating %}
                                <span class="meta languages">
                                    {% for language, translated_entry_count, translated_word_count, translated_word_percent in trends.target.tar_lang_list_with_translate_progress() %}
                                            <a href="{{ trends.target.read_link(language) }}"
                                               title="[{{ language|upper }}] {{ supported_languages[language] }} {{ translated_word_percent }}%"
                                               data-toggle="tooltip" data-placement="top" data-container="body"
                                               target="_blank">
                                                <span class="flag {{ language }}"></span>
                                            </a>
                                    {% endfor %}
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% if trends.target_type == 'task' %}
                    <div id="comment-list-{{ trends.target.id }}" style="display: none;">

                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        {{ empty_label }}
    {% endfor %}
{% endmacro %}

{% macro render_user_profile_card(user, extra_class="") %}
    <div class="user-profile-card {{ extra_class }}">
        <a href="{{ url_for('personal.index', user_id=user.id) }}" class="avatar">
            <img src="{{ user.avatar_url(40) }}" alt="{{ user.nickname }}"/>
        </a>
        <div class="card-content">
            <div class="card-heading">
                <div class="nickname">
                    <a href="{{ url_for('personal.index', user_id=user.id) }}" title="{{ user.nickname }}">
                        <strong>
                            {{ user.nickname|truncate(8, true) }}
                        </strong>
                    </a>
                </div>
                <div class="user-level">
                    <a href="javascript:void(0);" title="初出茅庐">
                        <i class="fa fa-star"></i>
                        <i class="fa fa-star"></i>
                        <i class="fa fa-star"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">

            </div>
        </div>
        {% if current_user.is_authenticated() and current_user.id == user.id %}
            <div class="contact-btns meta">
                <a href="{{ url_for('personal.published_tasks', user_id=user.id) }}">
                    <i class="fa fa-file-text-o" style="font-size: 13px"></i> 我的主题
                </a>
                {% if current_user.notice_number %}
                <a href="{{ url_for('notice.index') }}" class="text-alert">
                    <i class="fa fa-bell-o" style="font-size: 13px"></i> 我的通知({{ current_user.notice_number }})
                </a>
                {% else %}
                    <a href="{{ url_for('notice.index') }}">
                    <i class="fa fa-bell-o" style="font-size: 13px"></i> 我的通知
                </a>
                {% endif %}
            </div>
        {% endif %}
        {% if not current_user.is_authenticated() or (current_user.is_authenticated() and current_user.id != user.id) %}
            <div class="contact-btns meta">
                <a class="mail " href="{{ url_for('mail.write', to=user.id) }}">
                    <i class="fa fa-envelope-o"></i> 发站内信
                </a>
                {% if current_user.is_authenticated() and current_user.followed(user.id) %}
                    <a class="follow follow-user" href="javascript: void(0);" data-user_id="{{ user.id }}" data-loading-text="正在提交...">
                        <i class="fa fa-minus"></i> 取消关注
                    </a>
                {% else %}
                    <a class="follow follow-user" href="javascript: void(0);" data-user_id="{{ user.id }}" data-loading-text="正在提交...">
                        <i class="fa fa-plus"></i> 关注
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{% macro require_seajs(debug) %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/nowdo/sea-modules/seajs/seajs/2.2.1/sea.js') }}"></script>
    {% if debug %}
        <script type="text/javascript">
            seajs.config({
                debug: true
            });
        </script>
    {% endif %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/seajs-config.js') }}"></script>
{% endmacro %}

{% macro require_js(name) %}
    {% if name == 'underscore' %}
        <script type="text/javascript" src="{{ url_for('static', filename='js/lib/backbone/underscore-min.js') }}"></script>
    {% elif name == 'backbone' %}
        <script type="text/javascript" src="{{ url_for('static', filename='js/lib/backbone/backbone-min.js') }}"></script>
    {% elif name == 'wysiwyg' %}
        <script type="text/javascript" src="{{ url_for('static', filename='libs/bootstrap/js/bootstrap-wysiwyg.js') }}"></script>
    {% elif name == 'jquery-form' %}
        <script type="text/javascript" src="{{ url_for('static', filename='js/lib/jqueryplugin/jquery.form.min.js') }}"></script>
    {% elif name == 'swfobject' %}
        <script type="text/javascript" src="{{ url_for('static', filename='js/lib/swfobject/swfobject.js') }}"></script>
    {% endif %}
{% endmacro %}

{% macro require_css(name) %}
    {% if name == 'summernote' %}
        <link rel="stylesheet" href="{{ url_for('static', filename='js/nowdo/sea-modules/nowdo/summernote/0.5.2/summernote.css') }}"/>
{#        <link rel="stylesheet" href="{{ url_for('static', filename='js/nowdo/sea-modules/nowdo/summernote/0.5.2/summernote-bs3.css') }}"/>#}
    {% elif name == 'intro' %}
        <link rel="stylesheet" href="{{ url_for('static', filename='js/nowdo/sea-modules/nowdo/intro/0.8.0/introjs.css') }}"/>
    {% elif name == 'fancybox' %}
        <link rel="stylesheet" href="{{ url_for('static', filename='js/nowdo/sea-modules/nowdo/fancybox/2.1.5/fancybox.css') }}"/>
    {% endif %}
{% endmacro %}


{% macro render_publisher(create_task_form, form_action, task_type=['text', 'image', 'video']) %}
    <div class="panel panel-default panel-publisher">
        <div class="panel-heading">
            <div class="buttons btn-group btn-group-justified">
                {% if 'text' in task_type %}
                    <a class="publisher-btn btn" data-target="text" href="javascript:void(0);">
                        <div class="text icon"></div>
                        <div class="btn-text">
                            文本
                        </div>
                    </a>
                {% endif %}
                <a class="publisher-btn btn {% if 'image' not in task_type %}disabled{% endif %}" data-target="image" href="javascript:void(0);">
                    <div class="image icon"></div>
                    <div class="btn-text">
                        图片
                    </div>
                </a>
                <a class="publisher-btn btn {% if 'video' not in task_type %}disabled{% endif %}" data-target="video" href="javascript:void(0);">
                    <div class="video icon"></div>
                    <div class="btn-text">
                        网站
                    </div>
                </a>
            </div>
        </div>
        <div class="text-editor publisher-body">
            <form action="{{ form_action }}" method="post">
                {{ create_task_form.csrf_token }}
                {{ create_task_form.input_mode }}
                <div class="panel-body">
                    {{ create_task_form.task_name(class="form-control", placeholder="标题") }}
                    {{ create_task_form.task_content(class="form-control", rows='5') }}
                    {{ create_task_form.tags(class="form-control", placeholder="标签，多个标签用逗号分隔") }}
                </div>
                <div class="panel-footer">
                    <label class="checkbox-inline">
                        {{ create_task_form.status() }} 我要翻译这篇文章
                    </label>

                    <div class="language-select">
                        {{ create_task_form.src_lang() }}
                        <i class="fa fa-random"></i>
                        {{ create_task_form.tar_lang() }}
                    </div>

                    <button class="btn pull-right" type="submit" data-loading-text="正在发布...">发布</button>
                    <a class="btn task-preview pull-right" href="javascript:void(0);">预览</a>
                    <a class="btn close-editor pull-right" href="javascript:void(0);">取消</a>
                </div>
            </form>
        </div>
        <div class="img-uploader publisher-body">
        </div>
        <div class="coming publisher-body">
            <div class="panel-body">
                功能即将开放！
            </div>
        </div>
    </div>
{% endmacro %}

{# 注册邀请 #}
{#{% macro render_register_invitation() %}#}
{#    <div>#}
{#        <label for="register-invitation">邀请邮箱</label>#}
{#        <input id="register-invitation" type="text" value="" class="form-control">#}
{#    </div>#}
{#{% endmacro %}#}
